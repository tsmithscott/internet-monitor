name: Sync README to Docker Hub

on:
  push:
    branches: [ "main" ]
    paths: [ "README.md" ]

jobs:
  update-dockerhub-readme:
    name: Update Docker Hub Overview
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Upload README to Docker Hub
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_TOKEN }}
        REPO: internet-monitor
      run: |
        README_CONTENT=$(cat README.md)

        # Get JWT token
        TOKEN=$(curl -s -H "Content-Type: application/json" \
          -X POST \
          -d '{"username": "'"$DOCKER_USERNAME"'", "password": "'"$DOCKER_PASSWORD"'"}' \
          https://hub.docker.com/v2/users/login/ | jq -r .token)

        # Update Docker Hub repo description
        curl -s -X PATCH \
          -H "Content-Type: application/json" \
          -H "Authorization: JWT $TOKEN" \
          -d '{"full_description": "'"$(jq -Rs . <<< "$README_CONTENT")"'"}' \
          https://hub.docker.com/v2/repositories/$DOCKER_USERNAME/$REPO/
